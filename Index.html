<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Widget M√©t√©o - G√©oloc + Recherche</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Amatic+SC&family=Poppins&display=swap');

  :root {
    --color-bg: #fef9f4;
    --color-primary: #f7c6b8;
    --color-secondary: #c5d8d1;
    --color-accent: #b89fca;
    --color-text: #4a4a4a;
    --shadow: 0 4px 10px rgba(200, 180, 170, 0.3);
  }

  body {
    background: var(--color-bg);
    font-family: 'Poppins', sans-serif;
    display: flex;
    justify-content: center;
    padding: 40px;
  }

  .weather-widget {
    background: white;
    box-shadow: var(--shadow);
    border-radius: 15px;
    width: 360px;
    padding: 20px;
    text-align: center;
    color: var(--color-text);
    user-select: none;
  }

  .weather-widget h2 {
    font-family: 'Amatic SC', cursive;
    font-size: 2.2em;
    color: var(--color-accent);
    margin: 0 0 10px 0;
  }

  .location {
    font-weight: 600;
    font-size: 1.1em;
    margin-bottom: 15px;
  }

  .search-box {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
  }

  .search-box input {
    flex: 1;
    padding: 6px;
    border: 1px solid var(--color-secondary);
    border-radius: 8px;
    font-family: 'Poppins', sans-serif;
  }

  .search-box button {
    background: var(--color-primary);
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    color: white;
    font-weight: 600;
    cursor: pointer;
  }

  .search-box button:hover {
    background: var(--color-accent);
  }

  .forecast-container {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    flex-wrap: nowrap;
  }

  .day-forecast {
    background: var(--color-secondary);
    border-radius: 10px;
    padding: 10px;
    flex: 1;
    box-shadow: 0 2px 6px rgba(184, 159, 202, 0.3);
  }

  .day-forecast h3 {
    font-family: 'Amatic SC', cursive;
    margin: 0 0 8px 0;
    font-size: 1.3em;
    color: var(--color-primary);
  }

  .temp {
    font-weight: 700;
    font-size: 1.5em;
    color: var(--color-primary);
    margin-bottom: 6px;
  }

  .description {
    font-style: italic;
    text-transform: capitalize;
    font-size: 0.95em;
    margin-bottom: 6px;
    min-height: 40px;
  }

  .icon {
    width: 50px;
    height: 50px;
    margin: 0 auto;
  }

  .error {
    color: #c94c4c;
    font-weight: 700;
    margin-top: 10px;
  }

  .nav-buttons {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    gap: 20px;
  }

  .nav-buttons button {
    background: var(--color-primary);
    border: none;
    border-radius: 8px;
    padding: 6px 14px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    transition: background-color 0.3s ease;
  }

  .nav-buttons button:disabled {
    background: #e5c7bf;
    cursor: default;
  }

  .nav-buttons button:hover:not(:disabled) {
    background: var(--color-accent);
  }
</style>
</head>
<body>

<div class="weather-widget" role="region" aria-label="Widget m√©t√©o avec pr√©vision sur plusieurs jours avec navigation">
  <h2>Pr√©vision m√©t√©o</h2>
  
  <div class="search-box">
    <input type="text" id="cityInput" placeholder="Entrez une ville..." />
    <button id="searchBtn">OK</button>
  </div>

  <div class="location" id="location">Chargement...</div>
  <div class="forecast-container" id="forecast"></div>
  <div class="error" id="error"></div>
  
  <div class="nav-buttons">
    <button id="prevBtn" disabled>‚Üê Pr√©c√©dent</button>
    <button id="nextBtn" disabled>Suivant ‚Üí</button>
  </div>
</div>

<script>
  const API_KEY = 'bee85c5f8eaca0dfbc7b4ba83c08096c'; // üîπ Mets ici ta cl√© API OpenWeatherMap
  const DEFAULT_CITY = 'Lyon,FR';

  const locationEl = document.getElementById('location');
  const forecastEl = document.getElementById('forecast');
  const errorEl = document.getElementById('error');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const cityInput = document.getElementById('cityInput');
  const searchBtn = document.getElementById('searchBtn');

  let dailyKeys = [];
  let dailyData = {};
  let currentIndex = 0;
  const DAYS_PER_PAGE = 5;

  function getDayName(dateStr) {
    return new Date(dateStr).toLocaleDateString('fr-FR', { weekday: 'short' });
  }

  function averageTemp(temps) {
    return Math.round(temps.reduce((a,b) => a+b, 0) / temps.length);
  }

  function mostFrequent(arr) {
    return arr.sort((a,b) =>
      arr.filter(v => v===a).length - arr.filter(v => v===b).length
    ).pop();
  }

  function renderForecast() {
    forecastEl.innerHTML = '';
    const slice = dailyKeys.slice(currentIndex, currentIndex + DAYS_PER_PAGE);
    slice.forEach(day => {
      const entries = dailyData[day];
      const avgTemp = averageTemp(entries.map(e => e.main.temp));
      const mainDesc = mostFrequent(entries.map(e => e.weather[0].description));
      const mainIcon = mostFrequent(entries.map(e => e.weather[0].icon));

      forecastEl.innerHTML += `
        <div class="day-forecast">
          <h3>${getDayName(day)}</h3>
          <img class="icon" src="https://openweathermap.org/img/wn/${mainIcon}@2x.png" alt="${mainDesc}" />
          <div class="temp">${avgTemp}¬∞C</div>
          <div class="description">${mainDesc}</div>
        </div>
      `;
    });
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex + DAYS_PER_PAGE >= dailyKeys.length;
  }

  function displayForecast(data) {
    locationEl.textContent = `${data.city.name}, ${data.city.country}`;
    errorEl.textContent = '';
    dailyData = {};
    data.list.forEach(item => {
      const day = item.dt_txt.split(' ')[0];
      if (!dailyData[day]) dailyData[day] = [];
      dailyData[day].push(item);
    });
    dailyKeys = Object.keys(dailyData);
    currentIndex = 0;
    renderForecast();
    nextBtn.disabled = dailyKeys.length <= DAYS_PER_PAGE;
  }

  async function fetchForecast(query) {
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?${query}&appid=${API_KEY}&units=metric&lang=fr`);
      if (!res.ok) throw new Error('Ville introuvable ou probl√®me r√©seau');
      const data = await res.json();
      displayForecast(data);
    } catch (err) {
      errorEl.textContent = err.message;
      locationEl.textContent = '‚Äî';
    }
  }

  prevBtn.addEventListener('click', () => {
    if (currentIndex > 0) { currentIndex -= DAYS_PER_PAGE; renderForecast(); }
  });
  nextBtn.addEventListener('click', () => {
    if (currentIndex + DAYS_PER_PAGE < dailyKeys.length) { currentIndex += DAYS_PER_PAGE; renderForecast(); }
  });

  searchBtn.addEventListener('click', () => {
    const city = cityInput.value.trim();
    if (city) fetchForecast(`q=${city}`);
  });

  // üîπ G√©olocalisation automatique
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => fetchForecast(`lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`),
      () => fetchForecast(`q=${DEFAULT_CITY}`)
    );
  } else {
    fetchForecast(`q=${DEFAULT_CITY}`);
  }
</script>

</body>
</html>
